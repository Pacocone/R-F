<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RestaurantWorld App Demo</title>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <script>
 <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
    // Ejemplo:
    const firebaseConfig = {
    apiKey: "AIzaSyD9rX7_qm944Aj3g_MJMsbsgiunO5DQf9E",
    authDomain: "restaurantfriends-15b99.firebaseapp.com",
    projectId: "restaurantfriends-15b99",
    storageBucket: "restaurantfriends-15b99.firebasestorage.app",
    messagingSenderId: "529148827903",
    appId: "1:529148827903:web:48af7bedfde32d637d14ca",
    measurementId: "G-JRRZQFRK7T"
  };

    // Inicializa Firebase (compat)
    if (typeof firebaseConfig !== 'undefined') {
      const app     = firebase.initializeApp(firebaseConfig);
      const auth    = firebase.auth();
      const db      = firebase.firestore();
      const storage = firebase.storage();
      window._fb = { app, auth, db, storage };
    } else {
      console.warn('‚ö†Ô∏è Falta pegar firebaseConfig antes de publicar.');
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #181818; font-family: Arial, sans-serif; margin: 0; }
    .container { max-width: 430px; margin: 0 auto; background: #222; padding: 8px; border-radius: 16px; box-shadow: 0 4px 16px #111; color: #fff; }
    .tabs { display: flex; border-bottom: 2px solid #444; margin-bottom: 16px; gap: 4px; }
    .tab { flex: 1; padding: 10px 0; text-align: center; cursor: pointer; font-weight: bold; font-size: 1em; letter-spacing: 1px; color: #bbb; background: none; border: none; transition: color 0.2s; }
    .tab.active { color: #00eaff; border-bottom: 4px solid #00eaff; background: #181818; }
    .hidden { display: none; }
    h2 { text-align: center; margin-top: 0; font-size: 1.2em; color: #00eaff; letter-spacing: 1px; }
    .card { background: #282828; border-radius: 12px; box-shadow: 0 2px 8px #111; padding: 10px; margin-bottom: 12px; color: #fff; }
    .stars { color: #ffd700; font-size: 1.1em; cursor: pointer; }
    .btn { background: linear-gradient(90deg,#00eaff,#0056b3); color: #fff; border: none; padding: 10px 0; border-radius: 8px; cursor: pointer; margin-top: 8px; font-size: 1em; font-weight: bold; letter-spacing: 1px; width: 100%; box-shadow: 0 2px 8px #0056b3; }
    .btn:active { background: linear-gradient(90deg,#0056b3,#00eaff); }
    select, input, textarea { margin: 4px 0 8px 0; padding: 8px; border-radius: 6px; border: 1px solid #444; width: 100%; background: #181818; color: #fff; font-size: 1em; }
    label { font-weight: bold; color: #00eaff; }
    .flex-row { display: flex; gap: 4px; }
    .img-preview { width: 100px; height: 100px; object-fit: contain; margin-top: 6px; border: 1px solid #444; border-radius: 8px; background: #222; }
    .review-list { margin: 4px 0 0 12px; }
    .lang-theme { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .lang-theme select { width: 60%; }
    .lang-icon, .theme-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 4px; }
    .tab, .btn { text-shadow: 0 2px 8px #0056b3; }
    option { background: #181818; color: #fff; }
    ::placeholder { color: #bbb; }
    .restaurante-nombre { color: #00eaff; font-weight: bold; font-size: 1em; letter-spacing: 1px; }
    .explorar-controls { margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px; }
    .usuario-nombre { color: #ffd700; font-weight: bold; }
    .tab-content { margin-bottom: 16px; }
    .delete-btn { background: none; border: none; cursor: pointer; width: 32px; height: 32px; margin-top: 4px; display: flex; align-items: center; justify-content: center; }
    .delete-btn img { width: 20px; height: 20px; }
    @media (max-width: 600px) {
      .container { max-width: 98vw; padding: 2vw; }
      h2 { font-size: 1em; }
      .card { padding: 6px; }
      .img-preview { width: 70px; height: 70px; }
      .tab { font-size: 0.9em; }
      label, select, input, textarea { font-size: 0.95em; }
    }
    body.light-mode { background: #f9f9f9; }
    .container.light-mode { background: #fff; color: #222; }
    .light-mode select, .light-mode input, .light-mode textarea { background: #fff !important; color: #222 !important; border: 1px solid #bbb; }
    .light-mode .tab { color: #222; }
    .light-mode .tab.active { color: #0056b3; border-bottom: 4px solid #0056b3; background: #fff; }
    .light-mode .card { background: #f5f5f5; color: #222; }
    .light-mode label { color: #0056b3; }
    .light-mode .restaurante-nombre { color: #0056b3; }
  </style>
</head>
<!-- Modal para mostrar ticket -->
<div id="ticketModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; padding:16px; max-width:90vw; max-height:90vh; margin:auto; display:flex; flex-direction:column; align-items:center;">
    <img id="ticketImg" src="" style="max-width:80vw; max-height:70vh; border-radius:8px;">
    <button class="btn" onclick="document.getElementById('ticketModal').style.display='none';" style="margin-top:12px;">Cerrar</button>
  </div>
</div>
<body>
<!-- Ventana de registro modal dark -->
<div id="registroModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#222; color:#fff; border-radius:12px; padding:24px; max-width:340px; margin:auto; box-shadow:0 4px 16px #111;">
    <h2 style="color:#00eaff;">Registro de usuario</h2>
    <form id="registroForm" autocomplete="off">
      <label style="color:#00eaff;">Email:</label>
      <input type="email" id="regEmail" required style="background:#181818; color:#fff; border:1px solid #444;">
      <label style="color:#00eaff;">Contrase√±a:</label>
      <input type="password" id="regPassword" required style="background:#181818; color:#fff; border:1px solid #444;">
      <label style="color:#00eaff;">Nombre de usuario:</label>
      <input type="text" id="regUsername" required style="background:#181818; color:#fff; border:1px solid #444;">
      <button type="submit" class="btn" style="margin-top:12px;">Registrarse</button>
    </form>
    <div id="regMsg" style="margin-top:8px;"></div>
  </div>
</div>
<div class="container" id="mainContainer">
<!-- Modern header for app -->
<div style="text-align:center; margin-bottom:18px;">
  <span style="font-size:2.7em; font-family:'Segoe UI',Arial,sans-serif; font-weight:900; font-style:italic; letter-spacing:0.08em; color:#00eaff; text-shadow:0 2px 12px #0056b3,0 0 2px #fff;">
    R&amp;F
  </span>
  <br>
  <span style="font-size:1.1em; font-family:'Montserrat',Arial,sans-serif; font-weight:600; font-style:italic; letter-spacing:0.12em; color:#ffd700; text-shadow:0 1px 8px #222;">
    Restaurants and Friends
  </span>
</div>
  <div class="lang-theme">
    <span>
      <img class="lang-icon" id="langLogo" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1ea-1f1f8.svg" alt="ES">
      <select id="lang"></select>
    </span>
 <span>
  <img class="theme-icon" id="themeLogo" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f31e.svg" alt="Light">
  <select id="theme">
    <option value="light">Claro</option>
    <option value="dark">Oscuro</option>
  </select>
</span>  
  </div>
  <div class="tabs">
  <button class="tab active" id="tabBtn0"></button>
  <button class="tab" id="tabBtn1"></button>
  <button class="tab" id="tabBtn2"></button>
  <button class="tab" id="tabBtn3"></button>
  <button class="tab" id="tabBtn4"></button>
</div>
<!-- A√±adir Visita -->
<div id="tab0" class="tab-content">
  <h2 id="addTitle"></h2>
  <form id="visitForm" autocomplete="off">
    <label id="lblRestaurante"></label>
    <input type="text" id="restaurante" list="restauranteList" placeholder="">
    <datalist id="restauranteList"></datalist>
    <label id="lblFecha"></label>
    <input type="date" id="fecha">
    <label id="lblCiudad"></label>
    <input type="text" id="ciudadInput" list="ciudadList" placeholder="">
    <datalist id="ciudadList"></datalist>
    <label id="lblPais"></label>
    <input type="text" id="paisInput" list="paisList" placeholder="">
    <datalist id="paisList"></datalist>
    <label id="lblComensales"></label>
    <input type="number" id="comensales" min="1" value="" placeholder="">
    <label id="lblTotal"></label>
    <div class="flex-row">
      <input type="number" id="total" min="0" step="0.01">
      <select id="moneda"></select>
    </div>
    <label id="lblAvgPrice"></label>
    <input type="text" id="avgPrice" readonly>
    <label id="lblValoracion"></label>
    <div id="stars">
      <span class="stars" data-star="1">‚òÖ</span>
      <span class="stars" data-star="2">‚òÖ</span>
      <span class="stars" data-star="3">‚òÖ</span>
      <span class="stars" data-star="4">‚òÖ</span>
      <span class="stars" data-star="5">‚òÖ</span>
    </div>
    <input type="hidden" id="valoracion" value="0">
    <label id="lblRese√±a"></label>
    <textarea id="rese√±a" placeholder=""></textarea>
    <label id="lblTicket"></label>
    <input type="file" id="ticket" accept="image/*" capture="environment">
    <img id="ticketPreview" class="img-preview" style="display:none;">
    <button type="submit" class="btn" id="btnGuardar"></button>
  </form>
  <div id="visitMsg"></div>
</div>
<!-- Resumen -->
<div id="tab1" class="tab-content hidden">
  <h2 id="resumenTitle"></h2>
  <label for="year" id="lblYear"></label>
  <select id="year"></select>
  <label id="lblResumenRest"></label>
  <select id="resumenRest"></select>
  <label id="lblResumenPais"></label>
  <select id="resumenPais"></select>
  <label id="lblResumenCiudad"></label>
  <select id="resumenCiudad"></select>
  <div id="totalGastado" style="margin: 8px 0; font-weight: bold;"></div>
  <div id="resumenCards"></div>
</div>
<!-- Historial -->
<div id="tab2" class="tab-content hidden">
  <h2 id="historialTitle"></h2>
  <label id="lblHistRest"></label>
  <select id="histRest"></select>
  <label id="lblHistPais"></label>
  <select id="histPais"></select>
  <label id="lblHistCiudad"></label>
  <select id="histCiudad"></select>
  <div id="historialCards"></div>
</div>
<!-- Explorar -->
<div id="tab3" class="tab-content hidden">
  <h2 id="explorarTitle"></h2>
  <div class="explorar-controls">
    <label id="lblExpPais"></label>
    <select id="explorarPais"></select>
    <label id="lblExpCiudad"></label>
    <select id="explorarCiudad"></select>
    <label id="lblExpRest"></label>
    <select id="explorarRestaurante"></select>
    <label id="lblExpUsuario"></label>
    <select id="explorarUsuario"></select>
  </div>
  <div id="explorarCards"></div>
</div>
<!-- AMIGOS -->
<div id="tab4" class="tab-content hidden">
  <h2 id="amigosTitle"></h2>
  <label id="lblAmigosPais"></label>
  <select id="amigosPais"></select>
  <label id="lblAmigosCiudad"></label>
  <select id="amigosCiudad"></select>
  <label id="lblAmigosUsuario"></label>
  <select id="amigosUsuario"></select>
  <div id="amigosCards"></div>
</div>
<script>
  // Mapeos de pa√≠ses y ciudades para traducci√≥n
const countryMap = {
  'spain': { es: 'Espa√±a', en: 'Spain', fr: 'Espagne', de: 'Spanien', ar: 'ÿ•ÿ≥ÿ®ÿßŸÜŸäÿß', zh: 'Ë•øÁè≠Áâô' },
  'france': { es: 'Francia', en: 'France', fr: 'France', de: 'Frankreich', ar: 'ŸÅÿ±ŸÜÿ≥ÿß', zh: 'Ê≥ïÂõΩ' },
  'italy': { es: 'Italia', en: 'Italy', fr: 'Italie', de: 'Italien', ar: 'ÿ•Ÿäÿ∑ÿßŸÑŸäÿß', zh: 'ÊÑèÂ§ßÂà©' },
  'england': { es: 'Inglaterra', en: 'England', fr: 'Angleterre', de: 'England', ar: 'ÿ•ŸÜÿ¨ŸÑÿ™ÿ±ÿß', zh: 'Ëã±Ê†ºÂÖ∞' },
  'great britain': { es: 'Reino Unido', en: 'Great Britain', fr: 'Grande-Bretagne', de: 'Gro√übritannien', ar: 'ÿ®ÿ±Ÿäÿ∑ÿßŸÜŸäÿß ÿßŸÑÿπÿ∏ŸÖŸâ', zh: 'Â§ß‰∏çÂàóÈ¢†' },
  'united kingdom': { es: 'Reino Unido', en: 'United Kingdom', fr: 'Royaume-Uni', de: 'Vereinigtes K√∂nigreich', ar: 'ÿßŸÑŸÖŸÖŸÑŸÉÿ© ÿßŸÑŸÖÿ™ÿ≠ÿØÿ©', zh: 'Ëã±ÂõΩ' },
  'germany': { es: 'Alemania', en: 'Germany', fr: 'Allemagne', de: 'Deutschland', ar: 'ÿ£ŸÑŸÖÿßŸÜŸäÿß', zh: 'Âæ∑ÂõΩ' },
  'china': { es: 'China', en: 'China', fr: 'Chine', de: 'China', ar: 'ÿßŸÑÿµŸäŸÜ', zh: '‰∏≠ÂõΩ' },
  'japan': { es: 'Jap√≥n', en: 'Japan', fr: 'Japon', de: 'Japan', ar: 'ÿßŸÑŸäÿßÿ®ÿßŸÜ', zh: 'Êó•Êú¨' },
  'russia': { es: 'Rusia', en: 'Russia', fr: 'Russie', de: 'Russland', ar: 'ÿ±Ÿàÿ≥Ÿäÿß', zh: '‰øÑÁΩóÊñØ' },
  'uae': { es: 'Emiratos √Årabes', en: 'UAE', fr: '√âmirats arabes', de: 'VAE', ar: 'ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™', zh: 'ÈòøËÅîÈÖã' }
};
const cityMap = {
  'madrid': { es: 'Madrid', en: 'Madrid', fr: 'Madrid', de: 'Madrid', ar: 'ŸÖÿØÿ±ŸäÿØ', zh: 'È©¨Âæ∑Èáå' },
  'barcelona': { es: 'Barcelona', en: 'Barcelona', fr: 'Barcelone', de: 'Barcelona', ar: 'ÿ®ÿ±ÿ¥ŸÑŸàŸÜÿ©', zh: 'Â∑¥Â°ûÁΩóÈÇ£' },
  'paris': { es: 'Par√≠s', en: 'Paris', fr: 'Paris', de: 'Paris', ar: 'ÿ®ÿßÿ±Ÿäÿ≥', zh: 'Â∑¥Èªé' },
  'rome': { es: 'Roma', en: 'Rome', fr: 'Rome', de: 'Rom', ar: 'ÿ±ŸàŸÖÿß', zh: 'ÁΩóÈ©¨' },
  'london': { es: 'Londres', en: 'London', fr: 'Londres', de: 'London', ar: 'ŸÑŸÜÿØŸÜ', zh: '‰º¶Êï¶' }
};
function normalize(str) {
  return str.trim().toLowerCase().replace(/[√°√†√§√¢]/g,'a').replace(/[√©√®√´√™]/g,'e').replace(/[√≠√¨√Ø√Æ]/g,'i').replace(/[√≥√≤√∂√¥]/g,'o').replace(/[√∫√π√º√ª]/g,'u');
}
function translateCountry(str, lang) {
  let key = normalize(str);
  for (let k in countryMap) {
    if (key === k || key === normalize(countryMap[k].es) || key === normalize(countryMap[k].en) || key === normalize(countryMap[k].fr) || key === normalize(countryMap[k].de) || key === normalize(countryMap[k].ar) || key === normalize(countryMap[k].zh)) {
      return countryMap[k][lang] || str;
    }
  }
  return str;
}
function translateCity(str, lang) {
  let key = normalize(str);
  for (let k in cityMap) {
    if (key === k || key === normalize(cityMap[k].es) || key === normalize(cityMap[k].en) || key === normalize(cityMap[k].fr) || key === normalize(cityMap[k].de) || key === normalize(cityMap[k].ar) || key === normalize(cityMap[k].zh)) {
      return cityMap[k][lang] || str;
    }
  }
  return str;
}
const textos = {
  es: { 
    tabs: ['üçΩÔ∏è A√±adir Visita','üìä Resumen','üìú Historial','üçïüç£üçî Explorar','üë´ Amigos'],
    addTitle: 'üçΩÔ∏è A√±adir visita',
    resumenTitle: 'üìä Resumen de visitas',
    historialTitle: 'üìú Historial de visitas',
    explorarTitle: 'üçïüç£üçî Explorar restaurantes',
    amigosTitle: 'üë´ Amigos',
    lblRestaurante: 'üç¥ Nombre restaurante:',
    lblFecha: 'üìÖ Fecha de la visita:',
    lblCiudad: 'üèôÔ∏è Ciudad:',
    lblPais: 'üåç Pa√≠s:',
    lblComensales: 'üë• N√∫mero de comensales:',
    lblTotal: 'üí∏ Gasto total:',
    lblAvgPrice: 'üí∞ Precio medio por comensal:',
    lblValoracion: '‚≠ê Valoraci√≥n:',
    lblRese√±a: 'üìù Rese√±a:',
    lblTicket: 'üßæ Subir ticket:',
    btnGuardar: 'üíæ Guardar visita',
    lblYear: 'A√±o:',
    selectCiudad: 'Selecciona ciudad',
    selectPais: 'Selecciona pa√≠s',
    selectMoneda: 'Selecciona moneda',
    selectYear: 'Todos los a√±os',
    placeholderRestaurante: 'Introduce el nombre',
    placeholderCiudad: 'Introduce la ciudad',
    placeholderPais: 'Introduce el pa√≠s',
    placeholderRese√±a: 'Escribe tu rese√±a',
    lblHistRest: 'Restaurante:',
    lblHistCiudad: 'Ciudad:',
    lblHistPais: 'Pa√≠s:',
    lblExpRest: 'Restaurante:',
    lblExpCiudad: 'Ciudad:',
    lblExpPais: 'Pa√≠s:',
    lblExpUsuario: 'Usuario:',
    lblAmigosUsuario: 'Usuario:',
    lblAmigosCiudad: 'Ciudad:',
    lblAmigosPais: 'Pa√≠s:'
  },
  en: { 
    tabs: ['üçΩÔ∏è Add Visit','üìä Summary','üìú History','üçïüç£üçî Explore','üë´ Friends'],
    addTitle: 'üçΩÔ∏è Add visit',
    resumenTitle: 'üìä Visit summary',
    historialTitle: 'üìú Visit history',
    explorarTitle: 'üçïüç£üçî Explore restaurants',
    amigosTitle: 'üë´ Friends',
    lblRestaurante: 'üç¥ Restaurant name:',
    lblFecha: 'üìÖ Visit date:',
    lblCiudad: 'üèôÔ∏è City:',
    lblPais: 'üåç Country:',
    lblComensales: 'üë• Number of diners:',
    lblTotal: 'üí∏ Total spent:',
    lblAvgPrice: 'üí∞ Average price per diner:',
    lblValoracion: '‚≠ê Rating:',
    lblRese√±a: 'üìù Review:',
    lblTicket: 'üßæ Upload receipt:',
    btnGuardar: 'üíæ Save visit',
    lblYear: 'Year:',
    selectCiudad: 'Select city',
    selectPais: 'Select country',
    selectMoneda: 'Select currency',
    selectYear: 'All years',
    placeholderRestaurante: 'Enter name',
    placeholderCiudad: 'Enter city',
    placeholderPais: 'Enter country',
    placeholderRese√±a: 'Write your review',
    lblHistRest: 'Restaurant:',
    lblHistCiudad: 'City:',
    lblHistPais: 'Country:',
    lblExpRest: 'Restaurant:',
    lblExpCiudad: 'City:',
    lblExpPais: 'Country:',
    lblExpUsuario: 'User:',
    lblAmigosUsuario: 'User:',
    lblAmigosCiudad: 'City:',
    lblAmigosPais: 'Country:'
  },
  fr: { 
    tabs: ['üçΩÔ∏è Ajouter visite','üìä R√©sum√©','üìú Historique','üçïüç£üçî Explorer','üë´ Amis'],
    addTitle: 'üçΩÔ∏è Ajouter visite',
    resumenTitle: 'üìä R√©sum√© des visites',
    historialTitle: 'üìú Historique des visites',
    explorarTitle: 'üçïüç£üçî Explorer les restaurants',
    amigosTitle: 'üë´ Amis',
    lblRestaurante: 'üç¥ Nom du restaurant:',
    lblFecha: 'üìÖ Date de la visite:',
    lblCiudad: 'üèôÔ∏è Ville:',
    lblPais: 'üåç Pays:',
    lblComensales: 'üë• Nombre de convives:',
    lblTotal: 'üí∏ D√©pense totale:',
    lblAvgPrice: 'üí∞ Prix moyen par convive:',
    lblValoracion: '‚≠ê Note:',
    lblRese√±a: 'üìù Avis:',
    lblTicket: 'üßæ T√©l√©charger le ticket:',
    btnGuardar: 'üíæ Enregistrer la visite',
    lblYear: 'Ann√©e:',
    selectCiudad: 'S√©lectionner ville',
    selectPais: 'S√©lectionner pays',
    selectMoneda: 'S√©lectionner monnaie',
    selectYear: 'Toutes les ann√©es',
    placeholderRestaurante: 'Entrez le nom',
    placeholderCiudad: 'Entrez la ville',
    placeholderPais: 'Entrez le pays',
    placeholderRese√±a: '√âcrivez votre avis',
    lblHistRest: 'Restaurant:',
    lblHistCiudad: 'Ville:',
    lblHistPais: 'Pays:',
    lblExpRest: 'Restaurant:',
    lblExpCiudad: 'Ville:',
    lblExpPais: 'Pays:',
    lblExpUsuario: 'Utilisateur:',
    lblAmigosUsuario: 'Utilisateur:',
    lblAmigosCiudad: 'Ville:',
    lblAmigosPais: 'Pays:'
  },
  de: { 
    tabs: ['üçΩÔ∏è Besuch hinzuf√ºgen','üìä √úbersicht','üìú Historie','üçïüç£üçî Entdecken','üë´ Freunde'],
    addTitle: 'üçΩÔ∏è Besuch hinzuf√ºgen',
    resumenTitle: 'üìä Besuchs√ºbersicht',
    historialTitle: 'üìú Besuchshistorie',
    explorarTitle: 'üçïüç£üçî Restaurants entdecken',
    amigosTitle: 'üë´ Freunde',
    lblRestaurante: 'üç¥ Restaurantname:',
    lblFecha: 'üìÖ Besuchsdatum:',
    lblCiudad: 'üèôÔ∏è Stadt:',
    lblPais: 'üåç Land:',
    lblComensales: 'üë• Anzahl G√§ste:',
    lblTotal: 'üí∏ Gesamtausgabe:',
    lblAvgPrice: 'üí∞ Durchschnittspreis pro Gast:',
    lblValoracion: '‚≠ê Bewertung:',
    lblRese√±a: 'üìù Rezension:',
    lblTicket: 'üßæ Beleg hochladen:',
    btnGuardar: 'üíæ Besuch speichern',
    lblYear: 'Jahr:',
    selectCiudad: 'Stadt w√§hlen',
    selectPais: 'Land w√§hlen',
    selectMoneda: 'W√§hrung w√§hlen',
    selectYear: 'Alle Jahre',
    placeholderRestaurante: 'Name eingeben',
    placeholderCiudad: 'Stadt eingeben',
    placeholderPais: 'Land eingeben',
    placeholderRese√±a: 'Rezension schreiben',
    lblHistRest: 'Restaurant:',
    lblHistCiudad: 'Stadt:',
    lblHistPais: 'Land:',
    lblExpRest: 'Restaurant:',
    lblExpCiudad: 'Stadt:',
    lblExpPais: 'Land:',
    lblExpUsuario: 'Benutzer:',
    lblAmigosUsuario: 'Benutzer:',
    lblAmigosCiudad: 'Stadt:',
    lblAmigosPais: 'Land:'
  },
  ar: { 
    tabs: ['üçΩÔ∏è ÿ•ÿ∂ÿßŸÅÿ© ÿ≤Ÿäÿßÿ±ÿ©','üìä ŸÖŸÑÿÆÿµ','üìú ÿ™ÿßÿ±ŸäÿÆ','üçïüç£üçî ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ','üë´ ÿ£ÿµÿØŸÇÿßÿ°'],
    addTitle: 'üçΩÔ∏è ÿ•ÿ∂ÿßŸÅÿ© ÿ≤Ÿäÿßÿ±ÿ©',
    resumenTitle: 'üìä ŸÖŸÑÿÆÿµ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™',
    historialTitle: 'üìú ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≤Ÿäÿßÿ±ÿßÿ™',
    explorarTitle: 'üçïüç£üçî ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑŸÖÿ∑ÿßÿπŸÖ',
    amigosTitle: 'üë´ ÿ£ÿµÿØŸÇÿßÿ°',
    lblRestaurante: 'üç¥ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑ÿπŸÖ:',
    lblFecha: 'üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©:',
    lblCiudad: 'üèôÔ∏è ÿßŸÑŸÖÿØŸäŸÜÿ©:',
    lblPais: 'üåç ÿßŸÑÿØŸàŸÑÿ©:',
    lblComensales: 'üë• ÿπÿØÿØ ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ:',
    lblTotal: 'üí∏ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ŸÜŸÅÿßŸÇ:',
    lblAvgPrice: 'üí∞ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ≥ÿπÿ± ŸÑŸÉŸÑ ÿ¥ÿÆÿµ:',
    lblValoracion: '‚≠ê ÿßŸÑÿ™ŸÇŸäŸäŸÖ:',
    lblRese√±a: 'üìù ŸÖÿ±ÿßÿ¨ÿπÿ©:',
    lblTicket: 'üßæ ÿ±ŸÅÿπ ÿßŸÑÿ•ŸäÿµÿßŸÑ:',
    btnGuardar: 'üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≤Ÿäÿßÿ±ÿ©',
    lblYear: 'ÿßŸÑÿ≥ŸÜÿ©:',
    selectCiudad: 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿØŸäŸÜÿ©',
    selectPais: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿØŸàŸÑÿ©',
    selectMoneda: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÖŸÑÿ©',
    selectYear: 'ŸÉŸÑ ÿßŸÑÿ≥ŸÜŸàÿßÿ™',
    placeholderRestaurante: 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ',
    placeholderCiudad: 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿØŸäŸÜÿ©',
    placeholderPais: 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿØŸàŸÑÿ©',
    placeholderRese√±a: 'ÿßŸÉÿ™ÿ® ŸÖÿ±ÿßÿ¨ÿπÿ™ŸÉ',
    lblHistRest: 'ŸÖÿ∑ÿπŸÖ:',
    lblHistCiudad: 'ŸÖÿØŸäŸÜÿ©:',
    lblHistPais: 'ÿØŸàŸÑÿ©:',
    lblExpRest: 'ŸÖÿ∑ÿπŸÖ:',
    lblExpCiudad: 'ŸÖÿØŸäŸÜÿ©:',
    lblExpPais: 'ÿØŸàŸÑÿ©:',
    lblExpUsuario: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ:',
    lblAmigosUsuario: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ:',
    lblAmigosCiudad: 'ŸÖÿØŸäŸÜÿ©:',
    lblAmigosPais: 'ÿØŸàŸÑÿ©:'
  },
  zh: { 
    tabs: ['üçΩÔ∏è Ê∑ªÂä†ËÆøÈóÆ','üìä ÊëòË¶Å','üìú ÂéÜÂè≤','üçïüç£üçî Êé¢Á¥¢','üë´ ÊúãÂèã'],
    addTitle: 'üçΩÔ∏è Ê∑ªÂä†ËÆøÈóÆ',
    resumenTitle: 'üìä ËÆøÈóÆÊëòË¶Å',
    historialTitle: 'üìú ËÆøÈóÆÂéÜÂè≤',
    explorarTitle: 'üçïüç£üçî Êé¢Á¥¢È§êÂéÖ',
    amigosTitle: 'üë´ ÊúãÂèã',
    lblRestaurante: 'üç¥ È§êÂéÖÂêçÁß∞:',
    lblFecha: 'üìÖ ËÆøÈóÆÊó•Êúü:',
    lblCiudad: 'üèôÔ∏è ÂüéÂ∏Ç:',
    lblPais: 'üåç ÂõΩÂÆ∂:',
    lblComensales: 'üë• ‰∫∫Êï∞:',
    lblTotal: 'üí∏ ÊÄªËä±Ë¥π:',
    lblAvgPrice: 'üí∞ ‰∫∫Âùá‰ª∑Ê†º:',
    lblValoracion: '‚≠ê ËØÑÂàÜ:',
    lblRese√±a: 'üìù ËØÑËÆ∫:',
    lblTicket: 'üßæ ‰∏ä‰º†Á•®ÊçÆ:',
    btnGuardar: 'üíæ ‰øùÂ≠òËÆøÈóÆ',
    lblYear: 'Âπ¥‰ªΩ:',
    selectCiudad: 'ÈÄâÊã©ÂüéÂ∏Ç',
    selectPais: 'ÈÄâÊã©ÂõΩÂÆ∂',
    selectMoneda: 'ÈÄâÊã©Ë¥ßÂ∏Å',
    selectYear: 'ÊâÄÊúâÂπ¥‰ªΩ',
    placeholderRestaurante: 'ËæìÂÖ•ÂêçÁß∞',
    placeholderCiudad: 'ËæìÂÖ•ÂüéÂ∏Ç',
    placeholderPais: 'ËæìÂÖ•ÂõΩÂÆ∂',
    placeholderRese√±a: 'ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫',
    lblHistRest: 'È§êÂéÖ:',
    lblHistCiudad: 'ÂüéÂ∏Ç:',
    lblHistPais: 'ÂõΩÂÆ∂:',
    lblExpRest: 'È§êÂéÖ:',
    lblExpCiudad: 'ÂüéÂ∏Ç:',
    lblExpPais: 'ÂõΩÂÆ∂:',
    lblExpUsuario: 'Áî®Êà∑:',
    lblAmigosUsuario: 'Áî®Êà∑:',
    lblAmigosCiudad: 'ÂüéÂ∏Ç:',
    lblAmigosPais: 'ÂõΩÂÆ∂:'
  }
};
// Idiomas y banderas
const idiomas = [
  { code: 'es', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1ea-1f1f8.svg', label: 'Espa√±ol' },
  { code: 'en', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1ec-1f1e7.svg', label: 'English' },
  { code: 'fr', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1eb-1f1f7.svg', label: 'Fran√ßais' },
  { code: 'de', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1e9-1f1ea.svg', label: 'Deutsch' },
  { code: 'ar', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1e6-1f1ea.svg', label: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' },
  { code: 'zh', logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f1e8-1f1f3.svg', label: '‰∏≠Êñá' }
];
// Traducciones principales


// Monedas ampliadas
const monedas = [
  { code: '‚Ç¨', label: { es: 'Euro', en: 'Euro', fr: 'Euro', de: 'Euro', ar: 'ŸäŸàÿ±Ÿà', zh: 'Ê¨ßÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/20ac.svg' },
  { code: '$', label: { es: 'D√≥lar USA', en: 'US Dollar', fr: 'Dollar US', de: 'US-Dollar', ar: 'ÿØŸàŸÑÿßÿ± ÿ£ŸÖÿ±ŸäŸÉŸä', zh: 'ÁæéÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b5.svg' },
  { code: '¬£', label: { es: 'Libra esterlina', en: 'Pound Sterling', fr: 'Livre sterling', de: 'Pfund Sterling', ar: 'ÿ¨ŸÜŸäŸá ÿ•ÿ≥ÿ™ÿ±ŸÑŸäŸÜŸä', zh: 'Ëã±Èïë' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b7.svg' },
  { code: 'AED', label: { es: 'Dirham', en: 'Dirham', fr: 'Dirham', de: 'Dirham', ar: 'ÿØÿ±ŸáŸÖ', zh: 'Ëø™ÊãâÂßÜ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b6.svg' },
  { code: '¬•', label: { es: 'Yen japon√©s', en: 'Japanese Yen', fr: 'Yen japonais', de: 'Japanischer Yen', ar: 'ŸäŸÜ Ÿäÿßÿ®ÿßŸÜŸä', zh: 'Êó•ÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b4.svg' },
  { code: 'ÂÖÉ', label: { es: 'Yuan chino', en: 'Chinese Yuan', fr: 'Yuan chinois', de: 'Chinesischer Yuan', ar: 'ŸäŸàÿßŸÜ ÿµŸäŸÜŸä', zh: '‰∫∫Ê∞ëÂ∏Å' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b4.svg' },
  { code: 'A$', label: { es: 'D√≥lar australiano', en: 'Australian Dollar', fr: 'Dollar australien', de: 'Australischer Dollar', ar: 'ÿØŸàŸÑÿßÿ± ÿ£ÿ≥ÿ™ÿ±ÿßŸÑŸä', zh: 'Êæ≥ÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b5.svg' },
  { code: '‚ÇΩ', label: { es: 'Rublo ruso', en: 'Russian Ruble', fr: 'Rouble russe', de: 'Russischer Rubel', ar: 'ÿ±Ÿàÿ®ŸÑ ÿ±Ÿàÿ≥Ÿä', zh: '‰øÑÁΩóÊñØÂç¢Â∏É' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b2.svg' },
  { code: 'CHF', label: { es: 'Franco suizo', en: 'Swiss Franc', fr: 'Franc suisse', de: 'Schweizer Franken', ar: 'ŸÅÿ±ŸÜŸÉ ÿ≥ŸàŸäÿ≥ÿ±Ÿä', zh: 'ÁëûÂ£´Ê≥ïÈÉé' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b2.svg' },
  { code: 'DKK', label: { es: 'Corona danesa', en: 'Danish Krone', fr: 'Couronne danoise', de: 'D√§nische Krone', ar: 'ŸÉÿ±ŸàŸÜÿ© ÿØŸÜŸÖÿßÿ±ŸÉŸäÿ©', zh: '‰∏πÈ∫¶ÂÖãÊúó' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b2.svg' },
  { code: 'SGD', label: { es: 'D√≥lar de Singapur', en: 'Singapore Dollar', fr: 'Dollar de Singapour', de: 'Singapur-Dollar', ar: 'ÿØŸàŸÑÿßÿ± ÿ≥ŸÜÿ∫ÿßŸÅŸàÿ±Ÿä', zh: 'Êñ∞Âä†Âù°ÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b5.svg' },
  { code: 'CAD', label: { es: 'D√≥lar canadiense', en: 'Canadian Dollar', fr: 'Dollar canadien', de: 'Kanadischer Dollar', ar: 'ÿØŸàŸÑÿßÿ± ŸÉŸÜÿØŸä', zh: 'Âä†ÊãøÂ§ßÂÖÉ' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b5.svg' },
  { code: 'MXN', label: { es: 'Peso mexicano', en: 'Mexican Peso', fr: 'Peso mexicain', de: 'Mexikanischer Peso', ar: 'ÿ®Ÿäÿ≤Ÿà ŸÖŸÉÿ≥ŸäŸÉŸä', zh: 'Â¢®Ë•øÂì•ÊØîÁ¥¢' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b2.svg' },
  { code: 'BRL', label: { es: 'Real brasile√±o', en: 'Brazilian Real', fr: 'Real br√©silien', de: 'Brasilianischer Real', ar: 'ÿ±ŸäÿßŸÑ ÿ®ÿ±ÿßÿ≤ŸäŸÑŸä', zh: 'Â∑¥Ë•øÈõ∑‰∫öÂ∞î' }, logo: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4b2.svg' }
];

// Datos de ejemplo
let ciudades = ['Madrid','Barcelona','Par√≠s','Roma','London'];
let paises = ['Espa√±a','Francia','Italia','England','Great Britain'];
let usuarios = ['Paco','Ana','Luis'];
let restaurantes = ['La Tagliatella','Sushi House','Casa Paco'];
let visitas = []; // Ahora se llenar√° desde Firestore

// Inicializaci√≥n idioma y tema
function initLangTheme() {
  let langSel = document.getElementById('lang');
  langSel.innerHTML = idiomas.map(l => `<option value="${l.code}">${l.label}</option>`).join('');
  langSel.value = 'es';
  document.getElementById('theme').value = 'dark';
  setTheme();
}
function capitalizeInput(input) {
  let val = input.value;
  val = val.replace(/\b\w+\b/g, function(word) {
    // Pasa toda la palabra a min√∫scula
    word = word.toLowerCase();
    // Capitaliza la primera letra
    word = word.charAt(0).toUpperCase() + word.slice(1);
    // Fuerza la vocal tras "√±" a min√∫scula, aunque est√© en segunda posici√≥n
    return word.replace(/√±([A-Z√Å√â√ç√ì√ö])/g, function(m, v) {
      return '√±' + v.toLowerCase();
    }).replace(/√±([a-z√°√©√≠√≥√∫])/g, function(m, v) {
      return '√±' + v.toLowerCase();
    });
  });
  input.value = val;
}

// Actualiza textos y datalist
function setLang() {
  let lang = document.getElementById('lang').value;
  let t = textos[lang];
  document.getElementById('langLogo').src = idiomas.find(l => l.code === lang).logo;
  document.getElementById('tabBtn0').innerText = t.tabs[0];
  document.getElementById('tabBtn1').innerText = t.tabs[1];
  document.getElementById('tabBtn2').innerText = t.tabs[2];
  document.getElementById('tabBtn3').innerText = t.tabs[3];
  document.getElementById('tabBtn4').innerText = t.tabs[4];
  document.getElementById('addTitle').innerText = t.addTitle;
  document.getElementById('resumenTitle').innerText = t.resumenTitle;
  document.getElementById('historialTitle').innerText = t.historialTitle;
  document.getElementById('explorarTitle').innerText = t.explorarTitle;
  document.getElementById('amigosTitle').innerText = t.amigosTitle;
  document.getElementById('lblRestaurante').innerText = t.lblRestaurante;
  document.getElementById('lblFecha').innerText = t.lblFecha;
  document.getElementById('lblCiudad').innerText = t.lblCiudad;
  document.getElementById('lblPais').innerText = t.lblPais;
  document.getElementById('lblComensales').innerText = t.lblComensales;
  document.getElementById('lblTotal').innerText = t.lblTotal;
  document.getElementById('lblAvgPrice').innerText = t.lblAvgPrice;
  document.getElementById('lblValoracion').innerText = t.lblValoracion;
  document.getElementById('lblRese√±a').innerText = t.lblRese√±a;
  document.getElementById('lblTicket').innerText = t.lblTicket;
  document.getElementById('btnGuardar').innerText = t.btnGuardar;
  document.getElementById('lblYear').innerText = t.lblYear;
  document.getElementById('restaurante').placeholder = t.placeholderRestaurante;
  document.getElementById('ciudadInput').placeholder = t.placeholderCiudad;
  document.getElementById('paisInput').placeholder = t.placeholderPais;
  document.getElementById('rese√±a').placeholder = t.placeholderRese√±a;
  document.getElementById('lblHistRest').innerText = t.lblHistRest;
  document.getElementById('lblHistCiudad').innerText = t.lblHistCiudad;
  document.getElementById('lblHistPais').innerText = t.lblHistPais;
  document.getElementById('lblExpRest').innerText = t.lblExpRest;
  document.getElementById('lblExpCiudad').innerText = t.lblExpCiudad;
  document.getElementById('lblExpPais').innerText = t.lblExpPais;
  document.getElementById('lblExpUsuario').innerText = t.lblExpUsuario;
  document.getElementById('lblAmigosUsuario').innerText = t.lblAmigosUsuario;
  document.getElementById('lblAmigosCiudad').innerText = t.lblAmigosCiudad;
  document.getElementById('lblAmigosPais').innerText = t.lblAmigosPais;
  // Datalist ciudad/pais/restaurante
  document.getElementById('ciudadList').innerHTML = [...new Set(ciudades.map(c => translateCity(c, lang)))].map(c => `<option value="${c}">`).join('');
  document.getElementById('paisList').innerHTML = [...new Set(paises.map(p => translateCountry(p, lang)))].map(p => `<option value="${p}">`).join('');
  document.getElementById('restauranteList').innerHTML = [...new Set(restaurantes)].map(r => `<option value="${r}">`).join('');
  // Monedas con logo
  document.getElementById('moneda').innerHTML = monedas.map(m =>
    `<option value="${m.code}">${m.label[lang]}</option>`
  ).join('');
  document.getElementById('year').innerHTML = `<option value="todos">${t.selectYear}</option>` + [...new Set(visitas.map(v => new Date(v.fecha).getFullYear()))].map(a => `<option value="${a}">${a}</option>`).join('');
  document.getElementById('histRest').innerHTML = `<option value="todos">${t.tabs[0]}</option>` + restaurantes.map(r => `<option>${r}</option>`).join('');
  document.getElementById('histCiudad').innerHTML = `<option value="todos">${t.selectCiudad}</option>` + ciudades.map(c => `<option>${translateCity(c, lang)}</option>`).join('');
  document.getElementById('histPais').innerHTML = `<option value="todos">${t.selectPais}</option>` + paises.map(p => `<option>${translateCountry(p, lang)}</option>`).join('');
  document.getElementById('explorarRestaurante').innerHTML = `<option value="todos">${t.tabs[0]}</option>` + restaurantes.map(r => `<option>${r}</option>`).join('');
  document.getElementById('explorarCiudad').innerHTML = `<option value="todos">${t.selectCiudad}</option>` + ciudades.map(c => `<option>${translateCity(c, lang)}</option>`).join('');
  document.getElementById('explorarPais').innerHTML = `<option value="todos">${t.selectPais}</option>` + paises.map(p => `<option>${translateCountry(p, lang)}</option>`).join('');
  document.getElementById('explorarUsuario').innerHTML = `<option value="todos">${t.tabs[4]}</option>` + usuarios.map(u => `<option>${u}</option>`).join('');
  document.getElementById('amigosUsuario').innerHTML = `<option value="todos">${t.tabs[4]}</option>` + usuarios.map(u => `<option>${u}</option>`).join('');
  document.getElementById('amigosCiudad').innerHTML = `<option value="todos">${t.selectCiudad}</option>` + ciudades.map(c => `<option>${translateCity(c, lang)}</option>`).join('');
  document.getElementById('amigosPais').innerHTML = `<option value="todos">${t.selectPais}</option>` + paises.map(p => `<option>${translateCountry(p, lang)}</option>`).join('');
  document.getElementById('lblResumenRest').innerText = t.lblRestaurante;
  document.getElementById('lblResumenPais').innerText = t.lblPais;
  document.getElementById('lblResumenCiudad').innerText = t.lblCiudad;
  document.getElementById('resumenRest').innerHTML = `<option value="todos">${t.tabs[0]}</option>` + restaurantes.map(r => `<option>${r}</option>`).join('');
  document.getElementById('resumenPais').innerHTML = `<option value="todos">${t.selectPais}</option>` + paises.map(p => `<option>${translateCountry(p, lang)}</option>`).join('');
  document.getElementById('resumenCiudad').innerHTML = `<option value="todos">${t.selectCiudad}</option>` + ciudades.map(c => `<option>${translateCity(c, lang)}</option>`).join('');
  renderResumen();
  renderHistorial();
  renderExplorar();
  renderAmigosResumen();
}

// Modo claro/oscuro cl√°sico
document.getElementById('theme').onchange = setTheme;
function setTheme() {
  let theme = document.getElementById('theme').value;
  let themeLogo = document.getElementById('themeLogo');
  if (theme === 'light') {
    document.body.classList.add('light-mode');
    document.getElementById('mainContainer').classList.add('light-mode');
    themeLogo.src = "https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f31e.svg";
  } else {
    document.body.classList.remove('light-mode');
    document.getElementById('mainContainer').classList.remove('light-mode');
    themeLogo.src = "https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f319.svg";
  }
}

// Tabs
function showTab(idx) {
  for (let i = 0; i < 5; i++) {
    document.getElementById('tab'+i).classList.add('hidden');
    document.getElementById('tabBtn'+i).classList.remove('active');
  }
  document.getElementById('tab'+idx).classList.remove('hidden');
  document.getElementById('tabBtn'+idx).classList.add('active');
  if (idx === 1) renderResumen();
  if (idx === 2) renderHistorial();
  if (idx === 3) renderExplorar();
  if (idx === 4) renderAmigosResumen();
}
document.getElementById('tabBtn0').onclick = () => showTab(0);
document.getElementById('tabBtn1').onclick = () => showTab(1);
document.getElementById('tabBtn2').onclick = () => showTab(2);
document.getElementById('tabBtn3').onclick = () => showTab(3);
document.getElementById('tabBtn4').onclick = () => showTab(4);

// A√±adir Visita: Capitalizaci√≥n y c√°lculo precio medio
document.getElementById('restaurante').oninput = function() { capitalizeInput(this); };
document.getElementById('ciudadInput').oninput = function() { capitalizeInput(this); };
document.getElementById('paisInput').oninput = function() { capitalizeInput(this); };
document.getElementById('total').oninput = calcAvgPrice;
document.getElementById('comensales').oninput = calcAvgPrice;

function calcAvgPrice() {
  let total = parseFloat(document.getElementById('total').value) || 0;
  let comensales = parseInt(document.getElementById('comensales').value) || 1;
  document.getElementById('avgPrice').value = comensales > 0 ? (total / comensales).toFixed(2) : '';
}

// Valoraci√≥n estrellas
Array.from(document.querySelectorAll('#stars .stars')).forEach(star => {
  star.onclick = function() {
    let n = parseInt(this.getAttribute('data-star'));
    document.getElementById('valoracion').value = n;
    Array.from(document.querySelectorAll('#stars .stars')).forEach((s, i) => {
      s.style.color = i < n ? '#ffd700' : '#444';
    });
  };
});

// Ticket preview
document.getElementById('ticket').onchange = function(e) {
  let file = e.target.files[0];
  if (file) {
    let reader = new FileReader();
    reader.onload = function(ev) {
      let img = document.getElementById('ticketPreview');
      img.src = ev.target.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
};

// Guardar visita y actualizar datalist
document.getElementById('visitForm').onsubmit = async function(e) {
  e.preventDefault();
  const lang = document.getElementById('lang')?.value || 'es';
  const restaurante = document.getElementById('restaurante')?.value?.trim();
  const ciudad      = document.getElementById('ciudadInput')?.value?.trim();
  const pais        = document.getElementById('paisInput')?.value?.trim();
  const comensales  = parseInt(document.getElementById('comensales')?.value || '0', 10);
  const total       = parseFloat(document.getElementById('total')?.value || '0');
  const moneda      = document.getElementById('moneda')?.value || 'EUR';
  const valoracion  = parseInt(document.getElementById('valoracion')?.value || '0', 10);
  const rese√±a      = document.getElementById('rese√±a')?.value?.trim() || '';
  const fecha       = document.getElementById('fecha')?.value || new Date().toISOString().slice(0,10);
  const fileTicket  = (document.getElementById('ticket')?.files || [null])[0];

  const visitMsgEl  = document.getElementById('visitMsg');

  if (!restaurante || !ciudad || !pais || !total || !comensales) {
    if (visitMsgEl) visitMsgEl.innerHTML = '<span style="color:#ff4d4d;">Rellena todos los campos obligatorios.</span>';
    return;
  }

  const user = firebase.auth().currentUser;
  if (!user) {
    if (visitMsgEl) visitMsgEl.innerHTML = '<span style="color:#ff4d4d;">Debes iniciar sesi√≥n.</span>';
    return;
  }

  const translateCountry = (typeof window.translateCountry === 'function') ? window.translateCountry : (x)=>x;
  const translateCity    = (typeof window.translateCity === 'function') ? window.translateCity : (x)=>x;

  const paisTrad   = translateCountry(pais, lang);
  const ciudadTrad = translateCity(ciudad, lang);
  const usuario    = user.displayName || (user.email ? user.email.split('@')[0] : 'usuario');

  try {
    let ticketUrl = '';
    if (fileTicket && window._fb?.storage) {
      const ruta = `tickets/${user.uid}/${Date.now()}-${fileTicket.name}`;
      const ref  = _fb.storage.ref().child(ruta);
      await ref.put(fileTicket);
      ticketUrl = await ref.getDownloadURL();
    }

    await _fb.db.collection('visitas').add({
      usuario, usuarioId: user.uid,
      restaurante, ciudad: ciudadTrad, pais: paisTrad,
      fecha, comensales, total, moneda, valoracion, rese√±a,
      lat: null, lng: null,
      ticket: ticketUrl,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (visitMsgEl) visitMsgEl.innerHTML = '<span style="color:#00eaff;">Guardado OK</span>';
    this.reset();
    const prev = document.getElementById('ticketPreview');
    if (prev) prev.style.display = 'none';
    Array.from(document.querySelectorAll('#stars .stars')).forEach(s => s.style.color = '#444');
    const valEl = document.getElementById('valoracion');
    if (valEl) valEl.value = 0;
    if (typeof calcAvgPrice === 'function') calcAvgPrice();
  } catch (err) {
    if (visitMsgEl) visitMsgEl.innerHTML = `<span style="color:#ff4d4d;">Error: ${err.message}</span>`;
  }
};

// RESUMEN
function renderResumen() {
  let lang = document.getElementById('lang').value;
  let a√±oSeleccionado = document.getElementById('year').value;
  let restSel = document.getElementById('resumenRest').value;
  let ciudadSel = document.getElementById('resumenCiudad').value;
  let paisSel = document.getElementById('resumenPais').value;
  let filtradas = visitas.filter(v => {
    let a√±oOk = a√±oSeleccionado === 'todos' || new Date(v.fecha).getFullYear() == a√±oSeleccionado;
    let rOk = restSel === 'todos' || v.restaurante === restSel;
    let cOk = ciudadSel === 'todos' || normalize(v.ciudad) === normalize(ciudadSel);
    let pOk = paisSel === 'todos' || normalize(v.pais) === normalize(paisSel);
    return a√±oOk && rOk && cOk && pOk;
  });

  let totalesDivisa = {};
  filtradas.forEach(v => {
    if (!totalesDivisa[v.moneda]) totalesDivisa[v.moneda] = 0;
    totalesDivisa[v.moneda] += Number(v.total);
  });

  let totalHtml = Object.entries(totalesDivisa).map(([moneda, total]) =>
    `<div>${textos[lang].lblTotal} <span style="color:#00eaff;">${total} ${moneda}</span></div>`
  ).join('');
  document.getElementById('totalGastado').innerHTML = totalHtml;

  let grupos = {};
  filtradas.forEach(v => {
    let key = v.restaurante + '|' + normalize(v.ciudad) + '|' + normalize(v.pais);
    if (!grupos[key]) grupos[key] = { restaurante: v.restaurante, ciudad: v.ciudad, pais: v.pais, visitas: 0, totalGastado: 0, valoraciones: [], rese√±as: [], moneda: v.moneda, comensales: 0, preciosPorComensal: [], lat: v.lat, lng: v.lng };
    grupos[key].visitas += 1;
    grupos[key].totalGastado += Number(v.total);
    grupos[key].valoraciones.push(Number(v.valoracion));
    grupos[key].rese√±as.push({ usuario: v.usuario, rese√±a: v.rese√±a });
    grupos[key].comensales += Number(v.comensales);
    grupos[key].preciosPorComensal.push(Number(v.total) / Number(v.comensales));
  });

  let html = '';
  Object.values(grupos).forEach(grupo => {
    let valoracionMedia = grupo.valoraciones.length ? (grupo.valoraciones.reduce((a,b)=>a+b,0)/grupo.valoraciones.length).toFixed(1) : '0';
    let precioMedio = grupo.preciosPorComensal.length
        ? (grupo.preciosPorComensal.reduce((a,b)=>a+b,0)/grupo.preciosPorComensal.length).toFixed(2)
        : '0.00';
    let mapsLink = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(grupo.restaurante + ' ' + grupo.ciudad + ' ' + grupo.pais)}" target="_blank" style="color:#00eaff;">Google Maps</a>`;
    html += `<div class="card">
      <div class="restaurante-nombre">${grupo.restaurante}</div>
      <div>${textos[lang].lblCiudad.split(':')[0]}: ${grupo.ciudad}</div>
      <div>${textos[lang].lblPais.split(':')[0]}: ${grupo.pais}</div>
      <div><b>N√∫mero de visitas:</b> ${grupo.visitas}</div>
      <div>${textos[lang].lblTotal} <b>${grupo.totalGastado} ${grupo.moneda}</b></div>
      <div>${textos[lang].lblAvgPrice.split(':')[0]}: <b>${precioMedio} ${grupo.moneda}</b></div>
      <div>${textos[lang].lblValoracion.split(':')[0]}: <span class="stars">${'‚òÖ'.repeat(Math.round(valoracionMedia))}${'‚òÜ'.repeat(5-Math.round(valoracionMedia))}</span> (${valoracionMedia})</div>
      <div><b>${textos[lang].lblRese√±a.split(':')[0]}:</b><ul class="review-list">${grupo.rese√±as.map(r=>`<li><span class="usuario-nombre">${r.usuario}</span>: ${r.rese√±a}</li>`).join('')}</ul></div>
      ${mapsLink}
    </div>`;
  });
  document.getElementById('resumenCards').innerHTML = html;
}
document.getElementById('year').onchange = renderResumen;

// HISTORIAL
function renderHistorial() {
  let lang = document.getElementById('lang').value;
  let restSel = document.getElementById('histRest').value;
  let ciudadSel = document.getElementById('histCiudad').value;
  let paisSel = document.getElementById('histPais').value;
  let html = '';
  let filtradas = visitas.filter(v => {
    let rOk = restSel === 'todos' || v.restaurante === restSel;
    let cOk = ciudadSel === 'todos' || normalize(v.ciudad) === normalize(ciudadSel);
    let pOk = paisSel === 'todos' || normalize(v.pais) === normalize(paisSel);
    return rOk && cOk && pOk;
  });
  filtradas.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach((v, idx) => {
  let precioMedio = v.comensales > 0 ? (v.total / v.comensales).toFixed(2) : '0.00';
  html += `<div class="card">
    <div class="restaurante-nombre">${v.restaurante}</div>
    <div>(${v.ciudad}, ${v.pais})</div>
    <div>${textos[lang].lblFecha.split(':')[0]}: ${v.fecha}</div>
    <div>${textos[lang].lblComensales.split(':')[0]}: ${v.comensales}</div>
    <div>${textos[lang].lblTotal} ${v.total} ${v.moneda}</div>
    <div>${textos[lang].lblAvgPrice.split(':')[0]}: <b>${precioMedio} ${v.moneda}</b></div>
    <div>${textos[lang].lblValoracion.split(':')[0]}: <span class="stars">${'‚òÖ'.repeat(v.valoracion)}${'‚òÜ'.repeat(5-v.valoracion)}</span></div>
    <div>${textos[lang].lblRese√±a.split(':')[0]}: ${v.rese√±a}</div>
    ${v.ticket ? `<button class="btn" onclick="mostrarTicket('${v.ticket}')">Ver ticket</button>` : ''}
    <button class="btn delete-btn" title="Eliminar" onclick="eliminarVisita(${idx})"><img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f5d1.svg" alt="Eliminar"></button>
  </div>`;
});
  document.getElementById('historialCards').innerHTML = html;
}
window.eliminarVisita = function(idx) {
  let lang = document.getElementById('lang').value;
  let restSel = document.getElementById('histRest').value;
  let ciudadSel = document.getElementById('histCiudad').value;
  let paisSel = document.getElementById('histPais').value;
  // Filtra igual que en renderHistorial
  let filtradas = visitas.filter(v => {
    let rOk = restSel === 'todos' || v.restaurante === restSel;
    let cOk = ciudadSel === 'todos' || normalize(v.ciudad) === normalize(ciudadSel);
    let pOk = paisSel === 'todos' || normalize(v.pais) === normalize(paisSel);
    return rOk && cOk && pOk;
  });
  let visita = filtradas.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha))[idx];
  let iReal = visitas.findIndex(v =>
    v.restaurante === visita.restaurante &&
    v.ciudad === visita.ciudad &&
    v.pais === visita.pais &&
    v.fecha === visita.fecha &&
    v.usuario === visita.usuario
  );
  if (iReal > -1 && confirm('¬øSeguro que quieres eliminar esta visita?')) {
    visitas.splice(iReal, 1);
    renderHistorial();
    renderResumen();
    renderExplorar();
    renderAmigosResumen();
  }
};

function getTopActiveUsers(visitas, topN = 10) {
  let counts = {};
  visitas.forEach(v => {
    counts[v.usuario] = (counts[v.usuario] || 0) + 1;
  });
  return Object.entries(counts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, topN)
    .map(([usuario]) => usuario);
}

function getTopRatedRestaurants(visitas, usuarios, topN = 10) {
  let agrupados = {};
  visitas.forEach(v => {
    if (!usuarios.includes(v.usuario)) return;
    const key = v.restaurante + '|' + normalize(v.ciudad) + '|' + normalize(v.pais);
    if (!agrupados[key]) agrupados[key] = { nombre: v.restaurante, ciudad: v.ciudad, pais: v.pais, moneda: v.moneda, valoraciones: [], precios: [], rese√±as: [], visitas: 0 };
    agrupados[key].valoraciones.push(v.valoracion);
    agrupados[key].precios.push(v.total / v.comensales);
    agrupados[key].rese√±as.push({ usuario: v.usuario, rese√±a: v.rese√±a });
    agrupados[key].visitas += 1;
  });
  let arr = Object.values(agrupados).map(grupo => {
    grupo.valoracionMedia = grupo.valoraciones.length ? (grupo.valoraciones.reduce((a,b)=>a+b,0)/grupo.valoraciones.length) : 0;
    return grupo;
  });
  return arr.sort((a, b) => b.valoracionMedia - a.valoracionMedia).slice(0, topN);
}

function renderExplorar() {
  let lang = document.getElementById('lang').value;
  let restauranteSel = document.getElementById('explorarRestaurante').value;
  let ciudadSel = document.getElementById('explorarCiudad').value;
  let paisSel = document.getElementById('explorarPais').value;
  let usuarioSel = document.getElementById('explorarUsuario').value;
  let html = '';
  let filtradas = visitas.filter(v => {
    let rOk = restauranteSel === 'todos' || v.restaurante === restauranteSel;
    let cOk = ciudadSel === 'todos' || normalize(v.ciudad) === normalize(ciudadSel);
    let pOk = paisSel === 'todos' || normalize(v.pais) === normalize(paisSel);
    let uOk = usuarioSel === 'todos' || v.usuario === usuarioSel;
    return rOk && cOk && pOk && uOk;
  });

  // Si no hay filtros, mostrar top 10 de los 10 usuarios m√°s activos
  if (restauranteSel === 'todos' && ciudadSel === 'todos' && paisSel === 'todos' && usuarioSel === 'todos') {
    let topUsers = getTopActiveUsers(visitas, 10);
    let topRestaurantes = getTopRatedRestaurants(visitas, topUsers, 10);
    filtradas = [];
    topRestaurantes.forEach(grupo => {
      filtradas = filtradas.concat(
        visitas.filter(v =>
          v.restaurante === grupo.nombre &&
          normalize(v.ciudad) === normalize(grupo.ciudad) &&
          normalize(v.pais) === normalize(grupo.pais) &&
          topUsers.includes(v.usuario)
        )
      );
    });
  }

  let agrupados = {};
  filtradas.forEach(v => {
    const key = v.restaurante + '|' + normalize(v.ciudad) + '|' + normalize(v.pais);
    if (!agrupados[key]) agrupados[key] = { nombre: v.restaurante, ciudad: v.ciudad, pais: v.pais, moneda: v.moneda, precios: [], valoraciones: [], rese√±as: [], visitas: 0 };
    agrupados[key].precios.push(v.total / v.comensales);
    agrupados[key].valoraciones.push(v.valoracion);
    agrupados[key].rese√±as.push({ usuario: v.usuario, rese√±a: v.rese√±a });
    agrupados[key].visitas += 1;
  });
  Object.values(agrupados).forEach(grupo => {
    let precioMedio = grupo.precios.length ? (grupo.precios.reduce((a,b)=>a+b,0)/grupo.precios.length).toFixed(2) : '0.00';
    let valoracionMedia = grupo.valoraciones.length ? (grupo.valoraciones.reduce((a,b)=>a+b,0)/grupo.valoraciones.length).toFixed(1) : '0';
    let mapsLink = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(grupo.nombre + ' ' + grupo.ciudad + ' ' + grupo.pais)}" target="_blank" style="color:#00eaff;">Google Maps</a>`;
    html += `<div class="card">
      <div class="restaurante-nombre">${grupo.nombre}</div>
      <div>${textos[lang].lblPais.split(':')[0]}: ${grupo.pais}</div>
      <div>${textos[lang].lblCiudad.split(':')[0]}: ${grupo.ciudad}</div>
      <div><b>N√∫mero de visitas:</b> ${grupo.visitas}</div>
      <div>${textos[lang].lblAvgPrice.split(':')[0]}: <b>${precioMedio} ${grupo.moneda}</b></div>
      <div>${textos[lang].lblValoracion.split(':')[0]}: <span class="stars">${'‚òÖ'.repeat(Math.round(valoracionMedia))}${'‚òÜ'.repeat(5-Math.round(valoracionMedia))}</span> (${valoracionMedia})</div>
      <div><b>${textos[lang].lblRese√±a.split(':')[0]}:</b><ul class="review-list">${grupo.rese√±as.map(r=>`<li><span class="usuario-nombre">${r.usuario}</span>: ${r.rese√±a}</li>`).join('')}</ul></div>
      ${mapsLink}
    </div>`;
  });
  document.getElementById('explorarCards').innerHTML = html;
}

function renderAmigosResumen() {
  let lang = document.getElementById('lang').value;
  let usuarioSel = document.getElementById('amigosUsuario').value;
  let ciudadSel = document.getElementById('amigosCiudad').value;
  let paisSel = document.getElementById('amigosPais').value;
  let html = '';
  let filtradas = visitas.filter(v => {
    let uOk = usuarioSel === 'todos' || v.usuario === usuarioSel;
    let cOk = ciudadSel === 'todos' || normalize(v.ciudad) === normalize(ciudadSel);
    let pOk = paisSel === 'todos' || normalize(v.pais) === normalize(paisSel);
    return uOk && cOk && pOk;
  });

  // Si no hay filtros, mostrar top 10 de los 10 usuarios m√°s activos
  if (usuarioSel === 'todos' && ciudadSel === 'todos' && paisSel === 'todos') {
    let topUsers = getTopActiveUsers(visitas, 10);
    let topRestaurantes = getTopRatedRestaurants(visitas, topUsers, 10);
    filtradas = [];
    topRestaurantes.forEach(grupo => {
      filtradas = filtradas.concat(
        visitas.filter(v =>
          v.restaurante === grupo.nombre &&
          normalize(v.ciudad) === normalize(grupo.ciudad) &&
          normalize(v.pais) === normalize(grupo.pais) &&
          topUsers.includes(v.usuario)
        )
      );
    });
  }

  let agrupados = {};
  filtradas.forEach(v => {
    const key = v.restaurante + '|' + normalize(v.ciudad) + '|' + normalize(v.pais);
    if (!agrupados[key]) agrupados[key] = { nombre: v.restaurante, ciudad: v.ciudad, pais: v.pais, moneda: v.moneda, precios: [], valoraciones: [], rese√±as: [], visitas: 0 };
    agrupados[key].precios.push(v.total / v.comensales);
    agrupados[key].valoraciones.push(v.valoracion);
    agrupados[key].rese√±as.push({ usuario: v.usuario, rese√±a: v.rese√±a });
    agrupados[key].visitas += 1;
  });
  Object.values(agrupados).forEach(grupo => {
    let precioMedio = grupo.precios.length ? (grupo.precios.reduce((a,b)=>a+b,0)/grupo.precios.length).toFixed(2) : '0.00';
    let valoracionMedia = grupo.valoraciones.length ? (grupo.valoraciones.reduce((a,b)=>a+b,0)/grupo.valoraciones.length).toFixed(1) : '0';
    let mapsLink = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(grupo.nombre + ' ' + grupo.ciudad + ' ' + grupo.pais)}" target="_blank" style="color:#00eaff;">Google Maps</a>`;
    html += `<div class="card">
      <div class="restaurante-nombre">${grupo.nombre}</div>
      <div>${textos[lang].lblPais.split(':')[0]}: ${grupo.pais}</div>
      <div>${textos[lang].lblCiudad.split(':')[0]}: ${grupo.ciudad}</div>
      <div><b>N√∫mero de visitas:</b> ${grupo.visitas}</div>
      <div>${textos[lang].lblAvgPrice.split(':')[0]}: <b>${precioMedio} ${grupo.moneda}</b></div>
      <div>${textos[lang].lblValoracion.split(':')[0]}: <span class="stars">${'‚òÖ'.repeat(Math.round(valoracionMedia))}${'‚òÜ'.repeat(5-Math.round(valoracionMedia))}</span> (${valoracionMedia})</div>
      <div><b>${textos[lang].lblRese√±a.split(':')[0]}:</b><ul class="review-list">${grupo.rese√±as.map(r=>`<li><span class="usuario-nombre">${r.usuario}</span>: ${r.rese√±a}</li>`).join('')}</ul></div>
      ${mapsLink}
    </div>`;
  });
  document.getElementById('amigosCards').innerHTML = html;
}
document.getElementById('amigosUsuario').onchange = renderAmigosResumen;
document.getElementById('amigosCiudad').onchange = renderAmigosResumen;
document.getElementById('amigosPais').onchange = renderAmigosResumen;

// Inicializaci√≥n
initLangTheme();
setLang();
document.getElementById('lang').onchange = setLang;
document.getElementById('theme').onchange = setTheme;

document.getElementById('explorarPais').onchange = renderExplorar;
document.getElementById('explorarCiudad').onchange = renderExplorar;
document.getElementById('explorarRestaurante').onchange = renderExplorar;
document.getElementById('explorarUsuario').onchange = renderExplorar;
document.getElementById('histRest').onchange = renderHistorial;
document.getElementById('histPais').onchange = renderHistorial;
document.getElementById('histCiudad').onchange = renderHistorial;
document.getElementById('histRest').onchange = function() {
  document.getElementById('histPais').value = 'todos';
  document.getElementById('histCiudad').value = 'todos';
  renderHistorial();
};
document.getElementById('histPais').onchange = function() {
  document.getElementById('histRest').value = 'todos';
  document.getElementById('histCiudad').value = 'todos';
  renderHistorial();
};
document.getElementById('histCiudad').onchange = function() {
  document.getElementById('histRest').value = 'todos';
  document.getElementById('histPais').value = 'todos';
  renderHistorial();
};
function mostrarRegistroSiNecesario() {
  if (!localStorage.getItem('usuarioRegistrado')) {
    document.getElementById('registroModal').style.display = 'flex';
  }
}
document.getElementById('registroForm').onsubmit = async function(e) {
  e.preventDefault();
  const email    = document.getElementById('regEmail')?.value?.trim();
  const password = document.getElementById('regPassword')?.value?.trim();
  const username = document.getElementById('regUsername')?.value?.trim();
  const regMsg   = document.getElementById('regMsg');

  if (!email || !password || !username) {
    if (regMsg) regMsg.innerText = 'Completa todos los campos.';
    return;
  }

  if (!window._fb || !window._fb.auth) {
    if (regMsg) regMsg.innerText = 'Firebase no est√° inicializado (falta firebaseConfig).';
    return;
  }

  try {
    const cred = await _fb.auth.createUserWithEmailAndPassword(email, password);
    await cred.user.updateProfile({ displayName: username });
    await _fb.db.collection('users').doc(cred.user.uid).set({
      username, email, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    if (regMsg) regMsg.innerText = '';
    const modal = document.getElementById('registroModal');
    if (modal) modal.style.display = 'none';
  } catch (err) {
    if (err.code === 'auth/email-already-in-use') {
      try {
        const cred = await _fb.auth.signInWithEmailAndPassword(email, password);
        if (regMsg) regMsg.innerText = '';
        const modal = document.getElementById('registroModal');
        if (modal) modal.style.display = 'none';
      } catch (e2) {
        if (regMsg) regMsg.innerText = 'No se pudo iniciar sesi√≥n: ' + e2.message;
      }
    } else {
      if (regMsg) regMsg.innerText = 'Error: ' + err.message;
    }
  }
};

// Mostrar modal seg√∫n login real y actualizar "usuarios"
firebase.auth().onAuthStateChanged(async (user) => {
  const registroModal = document.getElementById('registroModal');
  if (user) {
    window.usuarios = Array.isArray(window.usuarios) ? window.usuarios : [];
    const display = user.displayName || (user.email ? user.email.split('@')[0] : 'usuario');
    if (!window.usuarios.includes(display)) window.usuarios.unshift(display);
    if (typeof setLang === 'function') setLang();
    if (registroModal) registroModal.style.display = 'none';
  } else {
    if (registroModal) registroModal.style.display = 'flex';
  }
});
window.onload = mostrarRegistroSiNecesario;
function seleccionarUsuarioRegistrado() {
  const reg = localStorage.getItem('usuarioRegistrado');
  if (reg) {
    const { username } = JSON.parse(reg);
    // Selecciona el usuario en los desplegables
    const selects = [
      'explorarUsuario',
      'amigosUsuario'
    ];
    selects.forEach(id => {
      const sel = document.getElementById(id);
      if (sel && [...sel.options].some(opt => opt.value === username || opt.text === username)) {
        sel.value = username;
      }
    });
  }
}
window.onload = function() {
  mostrarRegistroSiNecesario();
  seleccionarUsuarioRegistrado();
};
function mostrarTicket(src) {
  document.getElementById('ticketImg').src = src;
  document.getElementById('ticketModal').style.display = 'flex';
}
document.getElementById('resumenRest').onchange = renderResumen;
document.getElementById('resumenPais').onchange = renderResumen;
document.getElementById('resumenCiudad').onchange = renderResumen;
</script>

<script>
function startVisitasListener() {
  if (!window._fb || !window._fb.db) return;
  _fb.db.collection('visitas').orderBy('fecha', 'desc').onSnapshot((snap) => {
    window.visitas = [];
    snap.forEach(doc => window.visitas.push(doc.data()));
    if (typeof setLang === 'function') setLang();
  });
}
firebase.auth().onAuthStateChanged(user => { if (user) startVisitasListener(); });
</script>
